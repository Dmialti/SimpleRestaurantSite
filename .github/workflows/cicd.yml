name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      nginx: ${{ steps.filter.outputs.nginx }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            server:
              - 'server/**'
            nginx:
              - 'nginx/**'
            frontend:
              - 'client/**'
  test:
    needs: [changes]
    if: needs.changes.outputs.server == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: restaurant_db_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Create .env.test
        run: |
          echo "DATABASE_URL=postgresql://postgres:password@localhost:5432/restaurant_db_test?schema=public" >> .env.test
          echo "NODE_ENV=test" >> .env.test
          echo "JWT_ACCESS_SECRET=test_access_secret_123" >> .env.test
          echo "JWT_REFRESH_SECRET=test_refresh_secret_456" >> .env.test
          echo "PORT=3000" >> .env.test
          echo "REDIS_HOST=localhost" >> .env.test
          echo "REDIS_PORT=6379" >> .env.test

      - name: Generate Prisma Client
        run: npx dotenv -e .env.test -- prisma generate

      - name: Run Tests
        run: npm run test:e2e:full

  build-and-push:
    needs: [changes, test]
    if: |
      always() && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      (needs.changes.outputs.server == 'true' || needs.changes.outputs.nginx == 'true') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push Server image
        if: needs.changes.outputs.server == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-server:latest
      - name: Build and push Nginx image
        if: needs.changes.outputs.nginx == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./nginx
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-nginx:latest

  deploy-backend:
    needs: [changes, build-and-push]
    runs-on: ubuntu-latest
    if: always() && needs.build-and-push.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Copy config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.yml"
          target: "app"
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd app
            docker compose pull
            if [ "${{ needs.changes.outputs.server }}" = "true" ]; then
              docker compose up -d api
              docker compose exec -T api npx prisma migrate deploy
            fi
            if [ "${{ needs.changes.outputs.nginx }}" = "true" ]; then
              docker compose up -d --force-recreate nginx
            fi
            docker image prune -f

  deploy-frontend:
    needs: [changes]
    if: needs.changes.outputs.frontend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Deploy to Vercel
        id: deploy
        run: |
          URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --yes ${{ github.ref == 'refs/heads/main' && '--prod' || '' }})
          echo "url=$URL" >> $GITHUB_OUTPUT
        working-directory: ./client
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  unlighthouse-audit:
    needs: [deploy-frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Unlighthouse & Puppeteer
        run: |
          npm install -g @unlighthouse/cli puppeteer
          sudo apt-get update
          sudo apt-get install -y libgbm-dev

      - name: Run Unlighthouse Scan
        run: |
          unlighthouse-ci --site "${{ needs.deploy-frontend.outputs.deployment_url }}" \
                          --extra-headers "x-vercel-protection-bypass:${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" \
                          --mobile \
                          --output-path .unlighthouse/mobile \
                          --build-static
          unlighthouse-ci --site "${{ needs.deploy-frontend.outputs.deployment_url }}" \
                          --extra-headers "x-vercel-protection-bypass:${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" \
                          --desktop \
                          --output-path .unlighthouse/desktop \
                          --build-static

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unlighthouse-report
          path: .unlighthouse
          include-hidden-files: true
          retention-days: 7
