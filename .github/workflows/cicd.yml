name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      nginx: ${{ steps.filter.outputs.nginx }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            server:
              - 'server/**'
            nginx:
              - 'nginx/**'

  test:
    needs: changes
    if: needs.changes.outputs.server == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: restaurant_db_test
        ports: ["5432:5432"]
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
        image: redis:alpine
        ports: ["6379:6379"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json
      - run: npm ci
      - name: Create .env.test
        run: |
          echo "DATABASE_URL=postgresql://postgres:password@localhost:5432/restaurant_db_test?schema=public" >> .env.test
          echo "REDIS_HOST=localhost" >> .env.test
          echo "REDIS_PORT=6379" >> .env.test
      - run: npx dotenv -e .env.test -- prisma generate
      - run: npm run test:e2e:full

  build-and-push:
    needs: [changes, test]
    if: |
      always() && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      (needs.changes.outputs.server == 'true' || needs.changes.outputs.nginx == 'true') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Server image
        if: needs.changes.outputs.server == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-server:latest

      - name: Build and push Nginx image
        if: needs.changes.outputs.nginx == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./nginx
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-nginx:latest

  deploy:
    needs: [changes, build-and-push]
    runs-on: ubuntu-latest
    if: always() && needs.build-and-push.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Copy config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.yml"
          target: "app"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd app
            docker compose pull

            if [ "${{ needs.changes.outputs.server }}" = "true" ]; then
              docker compose up -d api
              docker compose exec -T api npx prisma migrate deploy
            fi

            if [ "${{ needs.changes.outputs.nginx }}" = "true" ]; then
              docker compose up -d --force-recreate nginx
            fi

            docker image prune -f
